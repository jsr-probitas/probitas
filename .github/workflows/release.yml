name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., v0.1.2)"
        required: true
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: write # For creating branches and PRs
      pull-requests: write

    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          token: ${{ secrets.PULL_REQUEST_TOKEN }}

      - uses: nixbuild/nix-quick-install-action@v34

      - name: Parse version
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          # Remove 'v' prefix if present
          VERSION_NO_V="${VERSION#v}"
          TAG="v${VERSION_NO_V}"
          echo "version=${VERSION_NO_V}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Run release task
        run: nix develop -c deno task release ${{ steps.version.outputs.tag }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PULL_REQUEST_TOKEN }}
          commit-message: "chore: bump version to ${{ steps.version.outputs.version }}"
          branch: release/${{ steps.version.outputs.tag }}
          delete-branch: true
          title: "chore: bump version to ${{ steps.version.outputs.version }}"
          body: |
            ## Summary
            - Update version to ${{ steps.version.outputs.version }} in deno.json
            - Update deno.lock to reflect new version
            - Update flake.lock with latest dependencies

            ## Test plan
            - [ ] CI checks pass (verify, scenario-test, scenario-test-nix)
            - [ ] Ready to merge and trigger publish workflow
          labels: release
          assignees: ${{ github.actor }}
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
